<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>3D Coin Collector</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: sans-serif;
      }
      #hud {
        position: absolute;
        top: 10px;
        left: 10px;
        color: #fff;
        font-size: 20px;
        z-index: 10;
      }
      #menu,
      #shopScreen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 20;
      }
      .btn {
        padding: 10px 20px;
        margin: 10px;
        background: #444;
        border: none;
        color: #fff;
        font-size: 20px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <!-- HUD wyświetlający liczbę zebranych monet -->
    <div id="hud">Monety: 0</div>

    <!-- Menu główne -->
    <div id="menu">
      <h1>Gra Coin Collector</h1>
      <button id="startBtn" class="btn">Start</button>
      <button id="shopBtn" class="btn">Sklep</button>
    </div>

    <!-- Ekran sklepu -->
    <div id="shopScreen" style="display: none;">
      <h1>Sklep</h1>
      <p>Koszt ulepszenia prędkości: 5 monet</p>
      <button id="buySpeedBtn" class="btn">Kup ulepszenie</button>
      <button id="exitShopBtn" class="btn">Powrót</button>
      <div id="shopMessage" style="margin-top:20px; color:#f00;"></div>
    </div>

    <!-- Import Three.js oraz kontrolerów z CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r152/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.152.0/examples/js/controls/PointerLockControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.152.0/examples/js/controls/OrbitControls.js"></script>

    <script>
      let scene, camera, renderer;
      let controls;
      let coinMeshes = [];
      let collectedCoins = 0;
      let playerSpeed = 5; // bazowa prędkość
      const coinCollectionDistance = 1.5; // odległość do zbierania monet

      let clock = new THREE.Clock();

      // Wykrywanie urządzenia – uproszczona detekcja mobilnego user agenta
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
        navigator.userAgent
      );

      // Inicjalizacja sceny
      function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb); // lekki błękit nieba

        camera = new THREE.PerspectiveCamera(
          75,
          window.innerWidth / window.innerHeight,
          0.1,
          1000
        );
        camera.position.y = 1.6; // wysokość oczu gracza

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Oświetlenie
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(10, 20, 10);
        directionalLight.castShadow = true;
        scene.add(directionalLight);

        // Teren
        const groundGeometry = new THREE.PlaneGeometry(100, 100);
        const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x228B22 });
        const ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.rotation.x = -Math.PI / 2;
        scene.add(ground);

        // Inicjalizacja monet
        createCoins();

        // Sterowanie – zależnie od urządzenia
        if (isMobile) {
          controls = new THREE.OrbitControls(camera, renderer.domElement);
          controls.enablePan = false;
          controls.enableZoom = false;
          controls.target.set(0, 1.6, 0);
        } else {
          controls = new THREE.PointerLockControls(camera, document.body);
          setupKeyboardControls();
        }

        window.addEventListener("resize", onWindowResize, false);
      }

      // Utworzenie 20 monet w losowych miejscach
      function createCoins() {
        const coinGeometry = new THREE.CylinderGeometry(0.5, 0.5, 0.1, 32, 1, true);
        const coinMaterial = new THREE.MeshStandardMaterial({
          color: 0xffd700,
          metalness: 1,
          roughness: 0.3,
        });
        for (let i = 0; i < 20; i++) {
          const coin = new THREE.Mesh(coinGeometry, coinMaterial);
          coin.rotation.x = Math.PI / 2; // obracamy, aby był poziomy
          // Losowe pozycje w zakresie -20 do 20 na osi X i Z
          coin.position.set(
            Math.random() * 40 - 20,
            0.5,
            Math.random() * 40 - 20
          );
          scene.add(coin);
          coinMeshes.push(coin);
        }
      }

      // Obsługa klawiatury dla PointerLockControls
      const move = { forward: false, backward: false, left: false, right: false };
      function setupKeyboardControls() {
        document.addEventListener("keydown", function (event) {
          switch (event.code) {
            case "KeyW":
              move.forward = true;
              break;
            case "KeyS":
              move.backward = true;
              break;
            case "KeyA":
              move.left = true;
              break;
            case "KeyD":
              move.right = true;
              break;
          }
        });
        document.addEventListener("keyup", function (event) {
          switch (event.code) {
            case "KeyW":
              move.forward = false;
              break;
            case "KeyS":
              move.backward = false;
              break;
            case "KeyA":
              move.left = false;
              break;
            case "KeyD":
              move.right = false;
              break;
          }
        });
      }

      // Aktualizacja HUD
      function updateHUD() {
        document.getElementById("hud").innerText = `Monety: ${collectedCoins}`;
      }

      // Logika ruchu gracza (dla PointerLockControls)
      function updatePlayer(delta) {
        if (!isMobile && controls && controls.isLocked) {
          const velocity = new THREE.Vector3();
          if (move.forward) velocity.z -= playerSpeed * delta;
          if (move.backward) velocity.z += playerSpeed * delta;
          if (move.left) velocity.x -= playerSpeed * delta;
          if (move.right) velocity.x += playerSpeed * delta;
          // Przekształcamy ruch z lokalnych współrzędnych kamery na światowe
          controls.moveRight(velocity.x);
          controls.moveForward(velocity.z);
        }
      }

      // Sprawdzanie kolizji gracza z monetami
      function checkCoinCollisions() {
        // Pozycja gracza – wykorzystujemy kamerę
        const playerPos = new THREE.Vector3();
        playerPos.setFromMatrixPosition(camera.matrixWorld);
        for (let i = coinMeshes.length - 1; i >= 0; i--) {
          const coin = coinMeshes[i];
          if (playerPos.distanceTo(coin.position) < coinCollectionDistance) {
            // Zbieramy monetę
            scene.remove(coin);
            coinMeshes.splice(i, 1);
            collectedCoins++;
            updateHUD();
          }
        }
      }

      // Główna pętla gry
      function gameLoop() {
        requestAnimationFrame(gameLoop);
        const delta = clock.getDelta();

        // Obracanie monet
        coinMeshes.forEach((coin) => {
          coin.rotation.z += delta; // obrót wokół osi Z
        });

        updatePlayer(delta);
        checkCoinCollisions();

        renderer.render(scene, camera);
      }

      // Aktualizacja rozmiarów okna
      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }

      // --- Obsługa interfejsu (menu i sklep) ---
      const menu = document.getElementById("menu");
      const shopScreen = document.getElementById("shopScreen");
      const startBtn = document.getElementById("startBtn");
      const shopBtn = document.getElementById("shopBtn");
      const exitShopBtn = document.getElementById("exitShopBtn");
      const buySpeedBtn = document.getElementById("buySpeedBtn");
      const shopMessage = document.getElementById("shopMessage");

      startBtn.addEventListener("click", () => {
        menu.style.display = "none";
        // Jeśli na PC, aktywujemy pointer lock
        if (!isMobile && controls) {
          controls.lock();
        }
      });

      shopBtn.addEventListener("click", () => {
        menu.style.display = "none";
        shopScreen.style.display = "flex";
      });

      exitShopBtn.addEventListener("click", () => {
        shopScreen.style.display = "none";
        menu.style.display = "flex";
        shopMessage.innerText = "";
      });

      buySpeedBtn.addEventListener("click", () => {
        if (collectedCoins >= 5) {
          collectedCoins -= 5;
          playerSpeed += 2; // zwiększamy prędkość
          updateHUD();
          shopMessage.style.color = "#0f0";
          shopMessage.innerText = "Ulepszenie zakupione!";
        } else {
          shopMessage.style.color = "#f00";
          shopMessage.innerText = "Za mało monet!";
        }
      });

      // Uruchomienie inicjalizacji i pętli gry
      init();
      gameLoop();
    </script>
  </body>
</html>