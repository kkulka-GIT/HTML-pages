<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>3D Coin Collector</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
    /* HUD: licznik monet */
    #hud {
      position: absolute;
      top: 10px;
      left: 10px;
      color: white;
      font-size: 20px;
      font-family: Arial, sans-serif;
      z-index: 10;
    }
    /* Menu główne */
    #menu, #shop {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      font-family: Arial, sans-serif;
      z-index: 20;
    }
    .menu-button {
      padding: 10px 20px;
      margin: 10px;
      background: #333;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }
    .menu-button:hover {
      background: #555;
    }
  </style>
</head>
<body>
  <div id="hud">Monety: 0</div>

  <div id="menu">
    <h1>3D Coin Collector</h1>
    <button id="startButton" class="menu-button">Start</button>
    <button id="shopButton" class="menu-button">Sklep</button>
  </div>

  <div id="shop" style="display:none;">
    <h1>Sklep</h1>
    <p>Kup ulepszenie prędkości (koszt: 5 monet)</p>
    <button id="buySpeed" class="menu-button">Kup</button>
    <p id="shopMessage"></p>
    <button id="backButton" class="menu-button">Powrót</button>
  </div>

  <!-- Three.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <!-- PointerLockControls (dla komputerów) -->
  <script src="https://threejs.org/examples/js/controls/PointerLockControls.js"></script>
  <!-- OrbitControls (dla urządzeń dotykowych) -->
  <script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
  <script>
    let scene, camera, renderer;
    let controls, orbitControls;
    let coins = [];
    let coinCount = 0;
    let moveSpeed = 0.1; // Początkowa prędkość ruchu
    let gameStarted = false;
    let keys = {};

    // Wykrycie urządzenia dotykowego
    let isMobile = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);

    init();
    animate();

    function init() {
      // Scena i kamera
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x87ceeb); // niebieskie niebo

      camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
      camera.position.set(0, 1.6, 5);

      // Renderer
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      // Oświetlenie
      let ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
      scene.add(ambientLight);
      let directionalLight = new THREE.DirectionalLight(0xffffff, 1);
      directionalLight.position.set(5, 10, 7.5);
      scene.add(directionalLight);

      // Teren – zielona płaszczyzna
      let planeGeometry = new THREE.PlaneGeometry(200, 200);
      let planeMaterial = new THREE.MeshLambertMaterial({ color: 0x228B22 });
      let plane = new THREE.Mesh(planeGeometry, planeMaterial);
      plane.rotation.x = -Math.PI / 2;
      scene.add(plane);

      // Utwórz monety (20 monet rozmieszczonych losowo)
      for (let i = 0; i < 20; i++) {
        let coin = createCoin();
        coin.position.set(
          Math.random() * 40 - 20,
          0.5,
          Math.random() * 40 - 20
        );
        scene.add(coin);
        coins.push(coin);
      }

      // Ustawienia sterowania w zależności od urządzenia
      if (!isMobile) {
        // Komputer: PointerLockControls (sterowanie FPS)
        controls = new THREE.PointerLockControls(camera, document.body);
        document.addEventListener('click', function () {
          controls.lock();
        });
        document.addEventListener('keydown', onKeyDown);
        document.addEventListener('keyup', onKeyUp);
      } else {
        // Telefon: OrbitControls (sterowanie dotykowe)
        orbitControls = new THREE.OrbitControls(camera, renderer.domElement);
        orbitControls.enablePan = false;
        orbitControls.enableZoom = false;
      }

      window.addEventListener('resize', onWindowResize, false);

      // Obsługa przycisków menu
      document.getElementById('startButton').addEventListener('click', startGame);
      document.getElementById('shopButton').addEventListener('click', openShop);
      document.getElementById('backButton').addEventListener('click', closeShop);
      document.getElementById('buySpeed').addEventListener('click', buySpeedUpgrade);
    }

    // Funkcja tworząca monetę
    function createCoin() {
      let geometry = new THREE.CylinderGeometry(0.5, 0.5, 0.1, 64);
      let material = new THREE.MeshStandardMaterial({
        color: 0xffd700,
        metalness: 1,
        roughness: 0.3
      });
      let coin = new THREE.Mesh(geometry, material);
      return coin;
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    // Obsługa klawiatury (dla komputerów)
    function onKeyDown(event) {
      keys[event.code] = true;
    }

    function onKeyUp(event) {
      keys[event.code] = false;
    }

    function animate() {
      requestAnimationFrame(animate);

      if (gameStarted) {
        // Ruch gracza dla komputerów
        if (!isMobile && controls.isLocked === true) {
          let direction = new THREE.Vector3();
          if (keys['KeyW']) direction.z -= 1;
          if (keys['KeyS']) direction.z += 1;
          if (keys['KeyA']) direction.x -= 1;
          if (keys['KeyD']) direction.x += 1;
          direction.normalize();

          // Przesunięcie w lokalnej przestrzeni kamery
          let moveX = direction.x * moveSpeed;
          let moveZ = direction.z * moveSpeed;
          let angle = camera.rotation.y;
          controls.getObject().position.x += moveX * Math.cos(angle) - moveZ * Math.sin(angle);
          controls.getObject().position.z += moveZ * Math.cos(angle) + moveX * Math.sin(angle);
        }

        // Animacja monet: obracanie i sprawdzanie kolizji
        for (let i = coins.length - 1; i >= 0; i--) {
          coins[i].rotation.z += 0.05;
          let coinPos = coins[i].position;
          let camPos = (!isMobile ? controls.getObject().position : camera.position);
          if (camPos.distanceTo(coinPos) < 1.0) {
            // Zbieranie monety
            scene.remove(coins[i]);
            coins.splice(i, 1);
            coinCount++;
            updateHUD();
          }
        }
      }

      // Aktualizacja OrbitControls dla urządzeń mobilnych
      if (isMobile && orbitControls) {
        orbitControls.update();
      }

      renderer.render(scene, camera);
    }

    // Rozpoczęcie gry: ukrycie menu i aktywacja sterowania
    function startGame() {
      document.getElementById('menu').style.display = 'none';
      gameStarted = true;
      if (!isMobile && controls) {
        controls.lock();
      }
    }

    // Aktualizacja HUD (licznik monet)
    function updateHUD() {
      document.getElementById('hud').innerText = 'Monety: ' + coinCount;
    }

    // Obsługa sklepu
    function openShop() {
      document.getElementById('menu').style.display = 'none';
      document.getElementById('shop').style.display = 'flex';
    }

    function closeShop() {
      document.getElementById('shop').style.display = 'none';
      document.getElementById('menu').style.display = 'flex';
    }

    function buySpeedUpgrade() {
      if (coinCount >= 5) {
        coinCount -= 5;
        moveSpeed += 0.05; // Zwiększenie prędkości ruchu
        updateHUD();
        document.getElementById('shopMessage').innerText = 'Ulepszono prędkość!';
      } else {
        document.getElementById('shopMessage').innerText = 'Za mało monet!';
      }
    }
  </script>
</body>
</html>
